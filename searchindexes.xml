<?xml version="1.0" encoding="utf-8" standalone="yes"?><search><entry><title>House_of_BotCake</title><url>/posts/house_of_botcake/</url><categories><category>Ctf</category></categories><tags><tag>Pwn</tag><tag>Ctf</tag></tags><content type="html"><![CDATA[  åˆ©ç”¨èƒŒæ™¯ è‡ª glibc 2.29 å¼€å§‹åŠ å…¥äº†å¯¹ tcache çš„ double free æ£€æŸ¥, ä½¿å¾—ä¹‹å‰çš„ tcache double free å¤±æ•ˆ
æºç è§£è¯» tcache ç»“æž„ä½“
1 2 3 4 5 6 typedef struct tcache_entry { struct tcache_entry *next; //é“¾è¡¨æŒ‡é’ˆï¼Œå¯¹åº”chunkä¸­çš„fdå­—æ®µ /* This field exists to detect double frees. */ struct tcache_perthread_struct *key; //æŒ‡å‘æ‰€å±žçš„tcacheç»“æž„ä½“ï¼Œå¯¹åº”chunkä¸­çš„bkå­—æ®µ } tcache_entry; tcache è¢«ç½®å…¥é“¾è¡¨
1 2 3 4 5 6 7 8 9 10 11 12 13 14 static __always_inline void tcache_put(mchunkptr chunk, size_t tc_idx) { tcache_entry *e = (tcache_entry *)chunk2mem(chunk); /* Mark this chunk as &#34;in the tcache&#34; so the test in _int_free will detect a double free. */ e-&gt;key = tcache; //è®¾ç½®æ‰€å±žçš„tcache e-&gt;next = tcache-&gt;entries[tc_idx];//å•é“¾è¡¨å¤´æ’æ³• tcache-&gt;entries[tc_idx] = e; ++(tcache-&gt;counts[tc_idx]); //è®¡æ•°å¢žåŠ  } tcache double free æ£€æŸ¥
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 size_t tc_idx = csize2tidx(size); // åªè¦tcacheä¸ä¸ºç©ºï¼Œå¹¶ä¸”è¿™ä¸ªchunkå±žäºŽtcacheç®¡è¾–èŒƒå›´ï¼Œé‚£ä¹ˆè¿™ä¸ªchunkå°±æœ‰å¯èƒ½å·²ç»åœ¨tcacheä¸­äº†ï¼Œæ‰€ä»¥éœ€è¦double freeæ£€æŸ¥ if (tcache != NULL &amp;&amp; tc_idx &lt; mp_.tcache_bins) { /* Check to see if it&#39;s already in the tcache. */ tcache_entry *e = (tcache_entry *)chunk2mem(p); /* å¦‚æžœæ˜¯double freeï¼Œé‚£ä¹ˆputæ—¶keyå­—æ®µè¢«è®¾ç½®äº†tcacheï¼Œå°±ä¼šè¿›å…¥å¾ªçŽ¯è¢«æ£€æŸ¥å‡ºæ¥ å¦‚æžœä¸æ˜¯ï¼Œé‚£ä¹ˆkeyå­—æ®µå°±æ˜¯ç”¨æˆ·æ•°æ®åŒºåŸŸï¼Œå¯ä»¥è§†ä¸ºéšæœºçš„ï¼Œåªæœ‰1/(2^size_t)çš„å¯èƒ½è¡Œè¿›å…¥å¾ªçŽ¯ï¼Œç„¶åŽå¾ªçŽ¯å‘çŽ°å¹¶ä¸æ˜¯double free */ if (__glibc_unlikely(e-&gt;key == tcache))//å‰ªæž { tcache_entry *tmp; LIBC_PROBE(memory_tcache_double_free, 2, e, tc_idx); for (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next) if (tmp == e) malloc_printerr(&#34;free(): double free detected in tcache 2&#34;); } if (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) //é€šè¿‡æ£€æŸ¥ï¼Œæ”¾å…¥tcahceä¸­ { tcache_put(p, tc_idx); return; } } åŠ¨æ€è°ƒè¯• å¯ä»¥æ¸…æ™°çš„çœ‹åˆ° bk å­—æ®µå³ key æŒ‡å‘å½“å‰çº¿ç¨‹çš„ tcache chunk åŒºåŸŸ
åˆ©ç”¨æ‰‹æ³• åˆ©ç”¨æ€è·¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // detail: https://github.com/shellphish/how2heap/blob/master/glibc_2.35/house_of_botcake.c #include &lt;stdlib.h&gt; #include &lt;stdint.h&gt; int main() { // malloc chunks intptr_t *x[7]; for(int i=0; i&lt;sizeof(x)/sizeof(intptr_t*); i++){ x[i] = malloc(0x100); } intptr_t *prev = malloc(0x100); intptr_t *victim = malloc(0x100); malloc(0x10); // free to fill tcache bins for(int i=0; i&lt;7; i++){ free(x[i]); } free(victim); free(prev); // Now, victim and prev already merge malloc(0x100); // double free free(victim); return 0; } åˆ©ç”¨è¯¦è§£ ä¸Šè¿°ä»£ç å†…å­˜å¸ƒå±€:
1 2 // line 20 free(victim); 1 2 // line 21 free(prev); æ­¤æ—¶ prev chunk å’Œ victim chunk å·²ç»åˆå¹¶
1 2 // line 23 malloc(0x100); æ­¤æ—¶ç”³è¯·å†…å­˜å—é¦–å…ˆä¼šä»Ž tcache bins è¿”å›žå†…å­˜å—
1 2 // line 25 free(victim); victim chunk å·²ç»è¢«é“¾æŽ¥è¿›äº† tcache bins
åªè¦ malloc åˆ° prev chunk è¿™å—å†…å­˜ï¼Œå°±å¯ä»¥è¿›è¡Œ tcache poisoning attack
æ¼æ´žæˆå›  æ­¤æ¼æ´žçš„é€ æˆæ˜¯å› ä¸º tcache çš„æ£€æŸ¥ä¸ä¸¥è°¨å¯¼è‡´çš„, free å‡½æ•°é€šè¿‡æ£€æµ‹å½“å‰ chunk å¤§å°æ˜¯å¦åœ¨ tcache èŒƒå›´å†…æ¥åˆ¤æ–­ double free
1 2 3 4 5 6 7 8 if (__glibc_unlikely(e-&gt;key == tcache))//å‰ªæž { tcache_entry *tmp; LIBC_PROBE(memory_tcache_double_free, 2, e, tc_idx); for (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next) if (tmp == e) malloc_printerr(&#34;free(): double free detected in tcache 2&#34;); } æ²¡æœ‰è€ƒè™‘åˆ° unsorted bins chunk è¢«ç½®å…¥ tcache æ²¡æœ‰ key çš„æƒ…å†µ
åˆ©ç”¨ç¤ºä¾‹ write here   ]]></content></entry><entry><title>Hello_world</title><url>/posts/hello_world/</url><categories><category>test</category></categories><tags><tag>test</tag></tags><content type="html">  md test~ ðŸ¤”
  </content></entry></search>